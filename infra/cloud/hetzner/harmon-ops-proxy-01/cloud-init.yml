#cloud-config

hostname: harmon-ops-proxy-01
fqdn: harmon-ops-proxy-01.local

timezone: UTC

users:
  - default
  - name: evan
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCxA0923Die2cxsJIyAZcJogygJG3SOsKoR7iaukI6XrSpOBnEcA3vAcZanwyxsox2Rp8v2ymzx3ABnsEKvxuM4IvkNRaFpQ2OK/Jw+EKC/uBJciGM2u8OOINst3DpxR1DsZgupyLWU2HuP0cz9o8ZT0U/ecKZEoqgSrm2C6Yy+gEFNrctVNMPWyHjaB3DDuPxMJSfGI8CrWx9eu6LeiWCp+czP5LhjrlNtpPyPoVvBTKIrSPUnEruFNCtTSxH04yCQxkcgzHLoC3Ic+6B+XLRWFvTto+SF+U2uPRkDsWP30kG/5oqEPWaBcL+TAtllM3NzTggkMG93liMbpQL6w0EOEwE2RZbgP/pTSR2Yme29oNj0eleDvrPSfdfbo7+1Th1AUGpgI6jLmvN8ZVMiOzzWEONGX4wVq72xN/kVVGI6/yz+wxh17ZKdRJIk4QsFgY53VRTBnbviygON/qWU1fy+SfqCxjjjfMxUNJKgfEMJUA5zf+KeTFlYK9BoDy9CVmQPgkXNGDq1BHB16sEP8p5ViCn0tYWgq53d8C/hsWf57yJk+seVT02uhXwyVki2NpDfSfcbSjl7Xu6gz65frNy0g+fhwZ6Aohv/zRcVwDniIJFxyxKAgGmm8Fq1etKaNAZ49kEkBG/1TmAO7VYl706jir75pEnpmA3KCEgIKVmHvw==

ssh_pwauth: false
disable_root: true

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades

write_files:
  - path: /etc/ufw/applications.d/traefik
    content: |
      [Traefik]
      title=Traefik
      description=Traefik reverse proxy
      ports=80,443/tcp

runcmd:
  # --- Docker install (official method) ---
  - curl -fsSL https://get.docker.com | sh

  # --- Enable Docker ---
  - systemctl enable docker
  - systemctl start docker

  # --- UFW baseline ---
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow OpenSSH
  - ufw allow Traefik
  - ufw --force enable

  # --- Fail2ban ---
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # --- Unattended upgrades ---
  - systemctl enable unattended-upgrades

final_message: |
  Cloud-init complete.
  Docker, firewall, and security baseline installed.
  Ready for Docker Compose deployment.
